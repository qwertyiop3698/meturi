<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>ë©”ì¶”ë¦¬ ì‹¤ì „ ì§€ë„ ì•±</title>
        <style>
            body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: sans-serif; }
            #map { width: 100%; height: calc(100vh - 60px); }
            
            .header { 
                height: 60px; background: #333; display: flex; 
                align-items: center; padding: 0 10px; box-sizing: border-box; gap: 5px;
            }
            input { 
                flex: 1; padding: 10px; border-radius: 4px; border: none; font-size: 16px; 
            }
            .btn { 
                padding: 10px 12px; border: none; border-radius: 4px; 
                font-weight: bold; cursor: pointer; white-space: nowrap;
            }
            .btn-search { background: #fee500; color: #3c1e1e; }
            .btn-myloc { background: #4285F4; color: white; }
        </style>
    </head>
    <body>

        <div class="header">
            <input type="text" id="keyword" placeholder="ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰" onkeypress="if(event.keyCode==13) searchPlaces()">
            <button class="btn btn-search" onclick="searchPlaces()">ê²€ìƒ‰</button>
            <button class="btn btn-myloc" onclick="moveToCurrentLocation()">í˜„ìœ„ì¹˜</button>
        </div>
        <div id="map"></div>

        <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=my_key&libraries=services"></script>

        <script>
        var mapContainer = document.getElementById('map'),
            mapOption = { 
                center: new kakao.maps.LatLng(37.4849, 126.9301), // ê¸°ë³¸ ì‹ ë¦¼ì—­
                level: 4 
            };

        var map = new kakao.maps.Map(mapContainer, mapOption);
        var ps = new kakao.maps.services.Places();
        var infowindow = new kakao.maps.InfoWindow({zIndex:1});
        var markers = []; // ë§ˆì»¤ ê´€ë¦¬ ë°°ì—´

        // [1] ì•± ì‹œì‘ ì‹œ í˜„ìœ„ì¹˜ë¡œ ì´ë™
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude, lon = position.coords.longitude;
                map.setCenter(new kakao.maps.LatLng(lat, lon));
            });
        }

        // [2] í˜„ìœ„ì¹˜ ì´ë™ í•¨ìˆ˜ (ë²„íŠ¼ìš©)
        function moveToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude, lon = position.coords.longitude;
                    var loc = new kakao.maps.LatLng(lat, lon);
                    map.panTo(loc);
                    
                    // í˜„ìœ„ì¹˜ í‘œì‹œ ë§ˆì»¤
                    removeMarker();
                    var marker = new kakao.maps.Marker({ map: map, position: loc });
                    markers.push(marker);
                });
            }
        }

        // [3] ê±°ë¦¬ìˆœ ê²€ìƒ‰ í•¨ìˆ˜
        var finalData = [];
        function searchPlaces() {
            var keyword = document.getElementById('keyword').value;
            if (!keyword.trim()) { alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            removeMarker();
            finalData = []; // ì´ˆê¸°í™”

            var searchOptions = {
                location: map.getCenter(),
                sort: kakao.maps.services.SortBy.DISTANCE,
                size: 15
            };

            collectPlaces(keyword, searchOptions);
        }

        // 45~50ê°œ ë°ì´í„°ë¥¼ ëª¨ìœ¼ëŠ” ì¬ê·€ í•¨ìˆ˜
        function collectPlaces(keyword, options) {
            ps.keywordSearch(keyword, function(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    finalData = finalData.concat(data);
                    
                    // 3í˜ì´ì§€(45ê°œ)ê¹Œì§€ í˜¹ì€ ë°ì´í„°ê°€ ì¶©ë¶„í•  ë•Œê¹Œì§€ ìˆ˜ì§‘
                    if (pagination.hasNextPage && finalData.length < 45) {
                        pagination.nextPage();
                    } else {
                        displayPlaces(finalData);
                    }
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            }, options);
        }

        // [4] ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
        function displayPlaces(data) {
            var bounds = new kakao.maps.LatLngBounds();
            var count = Math.min(data.length, 50);

            for (var i = 0; i < count; i++) {
                var marker = displayMarker(data[i]);
                markers.push(marker);
                bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
            }
            // ê±°ë¦¬ìˆœ ê²€ìƒ‰ì´ë¯€ë¡œ ì§€ë„ë¥¼ ì´ë™ì‹œí‚¤ì§€ ì•Šê³  í˜„ì¬ ì¤‘ì‹¬ ìœ ì§€ (ì„ íƒì‚¬í•­)
        }

        function displayMarker(place) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x) 
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                var content = '<div style="padding:10px; font-size:14px;">' +
                    '<strong>' + place.place_name + '</strong><br>' +
                    '<span style="font-size:12px; color:gray;">' + (place.distance ? place.distance + 'm' : '') + '</span><br>' +
                    '<a href="https://map.kakao.com/link/to/' + place.id + '" target="_blank" style="color:blue; text-decoration:none;">ğŸš© ê¸¸ì°¾ê¸°</a>' +
                    '</div>';
                infowindow.setContent(content);
                infowindow.open(map, marker);
            });
            return marker;
        }

        function removeMarker() {
            for (var i = 0; i < markers.length; i++) { markers[i].setMap(null); }
            markers = [];
        }
        </script>
    </body>
</html>